// 181102, 230801
/* 2018-03-15 */
// 2023-09-01: 181102(table-based) + 180315(place-holder for simd version + int64 optimization)

#include "base64_any.h"

static const char cs[] =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    "abcdefghijklmnopqrstuvwxyz"
    "0123456789+/"
    "=";
static const uint8_t cs2[256] = {
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,62, 0, 0, 0,63,52,53,54,55,56,57,58,59,60,61, 0, 0, 0, 0, 0, 0,
    0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25, 0, 0, 0, 0, 0,
    0,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
};


#ifdef BASE64_INT64
static int base64_srcbufsize(int size, int *out_chnks)
{
	int chnks = size / 3;
	int rem = size % 3;

	if (out_chnks)
		*out_chnks = chnks;

	return chnks * 3 + rem + 1;
}
int base64_any2_enc(uint8_t *dst, const uint8_t *src, size_t len)
{
	int rem, chnks;
	int offsetDst, offsetSrc;
	int ch;
	register uint64_t q0, q1, q2, q3;

	chnks = len / 6;
	rem = len - chnks * 6;

	offsetSrc = 0;
	offsetDst = 0;

	for (size_t i = 0; i < chnks; ++i)
	{
		q0 = *(uint16_t*)(src + offsetSrc + 0);
		q1 = *(uint16_t*)(src + offsetSrc + 2);
		q2 = *(uint16_t*)(src + offsetSrc + 4);
/*
6 2, 4 4,  2 6, 6 2,  4 4, 2 6
6, 2 4, 4 2, 6, 6, 2 4, 4 2, 6

big:
++++++++--------
>>1111110000000000<<<<<<
>>>>0000001111110000<<<<
>>>>>>0000000000001111<<
++++++++--------++++++++--------++++++++
>>>>>>>>>>>>>>>>>>>>>>1100000000000000<<<<<<<<<<
>>>>>>>>>>>>>>>>>>>>>>>>0011111100000000<<<<<<<<
>>>>>>>>>>>>>>>>>>>>>>>>>>0000000011111100<<<<<<
>>>>>>>>>>>>>>>>>>>>>>>>>>>>0000000000000011<<<<
++++++++--------++++++++--------++++++++--------++++++++
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>1111000000000000<<<<
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0000111111000000<<
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0000000000111111
++++++++--------++++++++--------++++++++--------++++++++--------
little:
++++++++--------++++++++--------++++++++--------++++++++--------
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>111111
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0000001111110000<<<<
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0000000000001111<<<<<<<<<<<<<<<<<<
++++++++--------++++++++--------++++++++--------++++++++--------
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>1100000000000000<<
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0011111100000000<<<<<<<<<<<<<<<<
>>>>>>>>>>>>>>>>>>0000000011111100<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
>>>>0000000000000011<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
++++++++--------++++++++--------++++++++--------++++++++
>>>>>>>>>>>>>>>>>>>>1111000000000000<<<<
>>>>>>0000111111000000<<<<<<<<<<<<<<<<<<
00111111<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
++++++++--------++++++++--------
*/
#ifdef BASE64_BIG_ENDIAN
		q3 =
			((q0 & 0xFC00) << 46) |
			((q0 & 0x03F0) << 44) |
			((q0 & 0x000F) << 42) |
			((q1 & 0xC000) << 26) |
			((q1 & 0x3F00) << 24) |
			((q1 & 0x00FC) << 22) |
			((q1 & 0x0003) << 20) |
			((q2 & 0xF000) << 4) |
			((q2 & 0x0FC0) << 2) |
			((q2 & 0x003F) << 0);
#else
		q3 =
			((q0 & 0xFC00) >> 10) |
			((q0 & 0x03F0) << 4) |
			((q0 & 0x000F) << 18) |
			((q1 & 0xC000) << 2) |
			((q1 & 0x3F00) << 16) |
			((q1 & 0x00FC) << 30) |
			((q1 & 0x0003) << 44) |
			((q2 & 0xF000) << 28) |
			((q2 & 0x0FC0) << 42) |
			((q2 & 0x003F) << 56);
#endif
		*(int64_t*)(dst + offsetDst + 0) = q3;


		offsetSrc += 6;
		offsetDst += 8;
	}

	for (size_t i = 0; i < chnks * 8; ++i)
	{
		ch = dst[offsetDst + i];

		dst[offsetDst + i] =
			  ch < 26 ? ch + 'A'
			: ch < 52 ? ch + 'a' - 52
			: ch < 62 ? ch + '0' - 62
			: ch == 62 ? '+'
			: '/';
	}

	return 1;
}
#endif

#ifndef BASE64_GENERIC_ENC
int base64_any_enc(
    uint8_t *dst,
    const uint8_t *src,
    size_t len)
{
    if (src == NULL || dst == NULL) return 0;

    size_t blocks = len / 3;
    size_t rest = len % 3;

    const uint8_t *p = src;
    uint8_t *q = dst;

    for (size_t i = 0; i < blocks; ++i)
    {
        uint32_t buf = *p++ << 16;
        buf |= *p++ << 8;
        buf |= *p++;

        *q++ = cs[(buf >> 18) & 0x3F];
        *q++ = cs[(buf >> 12) & 0x3F];
        *q++ = cs[(buf >> 6) & 0x3F];
        *q++ = cs[(buf >> 0) & 0x3F];
    }

    // 1 11111111 -> 111111 11____ _ _
    // 2 11111111 22222222 -> 111111 112222 2222__ _
    if (rest == 1)
    {
        uint32_t x = *p;

        *q++ = cs[(x >> 2) & 0x3F];
        *q++ = cs[((x & 3) << 4) & 0x3F];
        *q++ = '=';
        *q = '=';
    }
    else if (rest == 2)
    {
        uint32_t x = *p++;
        uint32_t y = *p;

        *q++ = cs[(x >> 2) & 0x3F];
        *q++ = cs[(((x & 3) << 4) | (y >> 4)) & 0x3F];
        *q++ = cs[((y & 0x0F) << 2) & 0x3F];
        *q = '=';
    }

    return 1;
}
#endif




int base64_any_dec(
    uint8_t *dst,
    const uint8_t *src,
    size_t len)
{
    if (src == NULL || dst == NULL) return 0;

    const uint8_t *p = src;
    uint8_t *q = dst;

    uint32_t buf = 0;
    int j = 0;

    for (size_t i = 0; i < len; ++i)
    {
        int c = *p++;
        int x = cs2[c];
        buf <<= 6;
        buf |= x;

        if (++j == 4)
        {
            *q++ = (buf >> 16) & 0xFF;
            *q++ = (buf >> 8) & 0xFF;
            *q++ = (buf >> 0) & 0xFF;

            buf = 0;
            j = 0;
        }
    }

    if (j > 0)
    {
        buf <<= 6 * j;

        *q++ = (buf >> 16) & 0xFF;
        *q++ = (buf >> 8) & 0xFF;
        *q++ = (buf >> 0) & 0xFF;
    }

    return 1;
}

